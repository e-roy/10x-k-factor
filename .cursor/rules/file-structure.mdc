---
alwaysApply: true
---


# 10x K Factor (PWA)

## Project Goals

* Ship **PWA-first** viral system with **≥4 closed-loop viral mechanics** and **≥4 agentic actions**.
* Prove lift with **K ≥ 1.20** on a 14-day cohort.
* Deliver **results share cards, smart links, presence/leaderboards, rewards, dashboards**.

## Tech Stack

* **App:** Next.js (App Router) + TypeScript + Tailwind + shadcn/ui
* **PWA:** `next-pwa` + Workbox SW, Web Push (VAPID)
* **Auth:** next-auth + Postgres (Neon)
* **DB/ORM:** Postgres + **Drizzle ORM**
* **Cache/Realtime:** Upstash Redis (presence, leaderboards, rate limits)
* **Agents:** **shared package** (`packages/agents`) imported by the Next.js app (no separate service)
* **LLM/Tools:** Vercel AI SDK (tool calling) — only from server routes/agents
* **Validation:** Zod

## Packages to Use

* Runtime: `next`, `react`, `react-dom`, `drizzle-orm`, `postgres`/`pg`, `zod`, `next-pwa`, `workbox-window`, `web-push`, `lucide-react`, `class-variance-authority`, `clsx`, `@vercel/og`, `ai` (Vercel AI SDK)
* UI: `tailwindcss`, `postcss`, `autoprefixer`, `shadcn/ui`
* Dev: `drizzle-kit`, `typescript`, `eslint`, `prettier`, `turbo`, `@types/node`

## Monorepo Structure (pnpm)

```
.
├─ apps/
│  └─ web/                         # Next.js PWA (UI + API + worker route)
│     ├─ app/
│     │  ├─ (app)/                 # authed routes
│     │  │  ├─ app/                # nested app routes
│     │  │  │  ├─ admin/
│     │  │  │  │  ├─ metrics/      # admin metrics page
│     │  │  │  │  │  ├─ page.tsx
│     │  │  │  │  │  ├─ form.tsx
│     │  │  │  │  │  └─ actions.ts
│     │  │  │  │  ├─ results/
│     │  │  │  │  │  └─ new/page.tsx
│     │  │  │  │  └─ test-data/page.tsx
│     │  │  │  ├─ cohorts/
│     │  │  │  │  ├─ new/page.tsx
│     │  │  │  │  └─ page.tsx
│     │  │  │  ├─ leaderboard/
│     │  │  │  │  ├─ [subject]/page.tsx
│     │  │  │  │  └─ page.tsx
│     │  │  │  ├─ results/
│     │  │  │  │  ├─ new/
│     │  │  │  │  └─ page.tsx
│     │  │  │  ├─ rewards/
│     │  │  │  │  └─ page.tsx
│     │  │  │  ├─ settings/
│     │  │  │  │  ├─ profile/page.tsx
│     │  │  │  │  └─ rewards/page.tsx
│     │  │  │  └─ page.tsx
│     │  │  └─ layout.tsx
│     │  ├─ api/
│     │  │  ├─ attribution/track-joined/route.ts
│     │  │  ├─ auth/[...nextauth]/route.ts
│     │  │  ├─ cohort/[id]/feed/route.ts
│     │  │  ├─ cohorts/route.ts
│     │  │  ├─ cron/refresh-rollups/route.ts
│     │  │  ├─ debug-env/route.ts
│     │  │  ├─ events/route.ts            # ingest → plan → inline/queue
│     │  │  ├─ health/route.ts
│     │  │  ├─ leaderboard/[subject]/route.ts
│     │  │  ├─ og/route.tsx                # share card generator
│     │  │  ├─ orchestrator/choose_loop/route.ts
│     │  │  ├─ personalize/compose/route.ts
│     │  │  ├─ presence/ping/route.ts
│     │  │  ├─ presence/stream/route.ts
│     │  │  ├─ rate-limit/invite/route.ts
│     │  │  ├─ results/route.ts
│     │  │  ├─ rewards/balances/route.ts
│     │  │  ├─ rewards/grant/route.ts
│     │  │  ├─ rewards/ledger/route.ts
│     │  │  ├─ search/
│     │  │  │  ├─ cohorts/route.ts
│     │  │  │  ├─ results/route.ts
│     │  │  │  └─ subjects/route.ts
│     │  │  └─ user/
│     │  │     ├─ me/route.ts
│     │  │     ├─ onboarding-complete/route.ts
│     │  │     └─ persona/route.ts
│     │  ├─ badge/[id]/page.tsx
│     │  ├─ cohort/[id]/page.tsx
│     │  ├─ fvm/skill/[deckId]/
│     │  │  ├─ not-found.tsx
│     │  │  └─ page.tsx
│     │  ├─ login/page.tsx
│     │  ├─ results/[id]/
│     │  │  ├─ not-found.tsx
│     │  │  └─ page.tsx
│     │  ├─ session/complete/page.tsx
│     │  ├─ sl/[code]/route.ts            # smart link resolver
│     │  ├─ ~offline/page.tsx
│     │  ├─ layout.tsx
│     │  ├─ page.tsx
│     │  └─ sw.ts
│     ├─ components/               # React components
│     │  ├─ app-layout/            # app layout components
│     │  │  ├─ CohortContext.tsx
│     │  │  ├─ CommandPalette.tsx
│     │  │  ├─ HeaderContent.tsx
│     │  │  ├─ SidebarNav.tsx
│     │  │  └─ UserMenu.tsx
│     │  ├─ landing-page/          # landing page components
│     │  ├─ ui/                    # shadcn/ui components
│     │  ├─ Breadcrumbs.tsx
│     │  ├─ CohortFeed.tsx
│     │  ├─ CohortSwitcher.tsx
│     │  ├─ FVMCompletionHandler.tsx
│     │  ├─ InviteButton.tsx
│     │  ├─ InviteJoinedTracker.tsx
│     │  ├─ InviteModal.tsx
│     │  ├─ LeaderboardWidget.tsx
│     │  ├─ LoginButton.tsx
│     │  ├─ MicroDeck.tsx
│     │  ├─ OnboardingSheet.tsx
│     │  ├─ OnboardingWrapper.tsx
│     │  ├─ PresencePill.tsx
│     │  ├─ PresenceWidget.tsx
│     │  ├─ RewardBadge.tsx
│     │  ├─ RewardPreview.tsx
│     │  ├─ RewardsBalances.tsx
│     │  ├─ RewardsLedger.tsx
│     │  └─ ShareButton.tsx
│     ├─ db/                       # Drizzle schema + client
│     │  ├─ schema.ts
│     │  ├─ auth-schema.ts
│     │  ├─ index.ts
│     │  └─ utils.ts
│     ├─ hooks/
│     │  └─ usePresence.ts
│     ├─ lib/
│     │  ├─ agents/                # agent orchestration & personalization
│     │  │  ├─ cooldowns.ts
│     │  │  ├─ orchestrator.ts
│     │  │  └─ personalize.ts
│     │  ├─ smart-links/           # smart link creation & attribution
│     │  │  ├─ attrib.ts
│     │  │  ├─ create.ts
│     │  │  ├─ index.ts
│     │  │  └─ signing.ts
│     │  ├─ rewards/
│     │  │  └─ policies.ts
│     │  ├─ auth.ts
│     │  ├─ decks.ts
│     │  ├─ leaderboard.ts
│     │  ├─ presence.ts
│     │  ├─ rate-limit.ts
│     │  ├─ safety.ts
│     │  ├─ streaks.ts
│     │  ├─ track.ts
│     │  └─ utils.ts
│     ├─ scripts/
│     │  ├─ create-mv.ts
│     │  └─ seed.ts
│     ├─ types/
│     │  └─ next-auth.d.ts
│     ├─ public/
│     │  ├─ manifest.json
│     │  ├─ sw.js
│     │  ├─ robots.txt
│     │  └─ icons/
│     ├─ styles/
│     │  └─ global.css
│     ├─ auth.config.ts
│     ├─ drizzle.config.ts
│     ├─ middleware.ts
│     ├─ next.config.mjs
│     ├─ postcss.config.mjs
│     ├─ components.json
│     └─ tsconfig.json
├─ packages/
│  ├─ agents/                      # shared agents package (no Next imports)
│  │  ├─ src/
│  │  │  ├─ types.ts
│  │  │  ├─ orchestrator.agent.ts
│  │  │  ├─ personalize.agent.ts
│  │  │  └─ index.ts               # export catalog
│  │  ├─ package.json
│  │  └─ tsconfig.json
│  └─ lib/                         # shared types/utilities
│     ├─ events.ts
│     ├─ index.ts
│     └─ package.json
├─ docs/
│  ├─ architecture.md
│  ├─ spec.md
│  ├─ sequence.md
│  ├─ phases/
│  └─ iterations/
├─ turbo.json
├─ pnpm-workspace.yaml
├─ pnpm-lock.yaml
├─ .env.example
└─ README.md
```

> **Do not create** `apps/agents` or any separate agent server.

## Conventions & Constraints

* **No `any`**; strict TS. Keep files **≤ 350 LOC**.
* **Types in `types/`**, helpers in `lib/`.
* **Ask if unsure**; prefer small, focused PRs.
* **Security:** never store raw PII; hash where needed (salted SHA-256) and minimize payloads.
* **Privacy:** share cards are **PII-free**; minors require consent before external shares.
* **Runtime:** Agents execute **inside Next.js** (inline or via job worker route).

## Agent Runtime (must follow)

* **Events:** `POST /api/events` persists `events` and plans agent runs.
* **Jobs:** enqueue background work into `jobs` (idempotent via `dedupe_key`).
* **Worker:** Background jobs are processed via cron routes (e.g., `/api/cron/refresh-rollups`).
* **Scheduling:** Vercel Cron calls cron routes as configured.
* **Inline path:** UI-critical actions may run synchronously within `/api/events`.

## Implementation Priorities

1. **PWA shell** (SW + manifest) and primary routes: **results**, **cohort**, **FVM micro-deck**.
2. **Drizzle + Postgres** schema & migrations; seed script.
3. **Events pipeline** (`/api/events`) → agent planning (import from `packages/agents`).
4. **Smart links** (HMAC, TTL, attribution cookie) + **share cards** (`@vercel/og`).
5. **Presence (SSE) + leaderboards** (Redis ZSET).
6. **Rewards & ledger**; trust & safety caps, rate limits.
7. **Admin metrics page** (basic funnels/leaderboard snapshots via SQL views).
8. **A/B flags** persisted on events and recorded in `agent_runs`.

## Scripts

* `pnpm dev` — run Next locally (**assume a dev server is already running; do not auto-start others**)
* `pnpm build` / `pnpm lint` / `pnpm format`
* `pnpm drizzle:gen` / `pnpm drizzle:push` / `pnpm seed`

## Environment (.env.example)

```
DATABASE_URL=postgres://user:pass@host/db
UPSTASH_REDIS_REST_URL=
UPSTASH_REDIS_REST_TOKEN=

AUTH_URL=http://localhost:3000
AUTH_SECRET=
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=

NEXT_PUBLIC_APP_URL=http://localhost:3000
SMARTLINK_HMAC_SECRET=changeme
VAPID_PUBLIC_KEY=
VAPID_PRIVATE_KEY=
```

## Vercel Cron

Configure cron jobs in `vercel.json` at the root (if needed). Example:

```json
{
  "crons": [
    { "path": "/api/cron/refresh-rollups", "schedule": "*/1 * * * *" }
  ]
}
```

## Definition of Done (MVP)

* **4 viral loops** working end-to-end (trigger → share → join → FVM → reward).
* **4 agentic actions** wired (≥2 student, ≥2 tutor) using the **shared agents package**.
* **Presence + leaderboards** visible; **smart links + attribution** functional.
* **Admin metrics** show K and funnel snapshots (SQL views; no external analytics service).


