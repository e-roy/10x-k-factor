# Visual Architecture & Data Flow

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER EXPERIENCE LAYER                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚   Student   â”‚    â”‚   Parent    â”‚    â”‚    Tutor    â”‚             â”‚
â”‚  â”‚  Dashboard  â”‚    â”‚  Dashboard  â”‚    â”‚  Dashboard  â”‚             â”‚
â”‚  â”‚             â”‚    â”‚             â”‚    â”‚             â”‚             â”‚
â”‚  â”‚ â€¢ Radial    â”‚    â”‚ â€¢ Progress  â”‚    â”‚ â€¢ Session   â”‚             â”‚
â”‚  â”‚   Progress  â”‚    â”‚   Overview  â”‚    â”‚   Schedule  â”‚             â”‚
â”‚  â”‚ â€¢ Streaks   â”‚    â”‚ â€¢ Safe      â”‚    â”‚ â€¢ Student   â”‚             â”‚
â”‚  â”‚ â€¢ Challengesâ”‚    â”‚   Sharing   â”‚    â”‚   Roster    â”‚             â”‚
â”‚  â”‚ â€¢ XP Bars   â”‚    â”‚ â€¢ Highlightsâ”‚    â”‚ â€¢ Spotlight â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                  â”‚                   â”‚                     â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                            â”‚                                         â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚                  â”‚   Agent Buddy     â”‚ â—„â”€â”€â”€ Speech Bubbles          â”‚
â”‚                  â”‚                   â”‚      with Interactive CTAs    â”‚
â”‚                  â”‚ â€¢ Speech Bubbles  â”‚                               â”‚
â”‚                  â”‚ â€¢ Context-Aware   â”‚                               â”‚
â”‚                  â”‚ â€¢ Animated GIF    â”‚                               â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                            â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    Triggers Actions
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ORCHESTRATION LAYER                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  User Action (Session Complete / Results Viewed / Badge Earned)      â”‚
â”‚         â”‚                                                             â”‚
â”‚         â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚  Track Event â”‚â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  POST /api/     â”‚                        â”‚
â”‚  â”‚              â”‚        â”‚  events         â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                   â”‚                                  â”‚
â”‚                        Insert into events table                      â”‚
â”‚                                   â”‚                                  â”‚
â”‚                                   â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚         Loop Orchestrator Agent                    â”‚             â”‚
â”‚  â”‚  POST /api/orchestrator/choose_loop                â”‚             â”‚
â”‚  â”‚                                                     â”‚             â”‚
â”‚  â”‚  Input:                                            â”‚             â”‚
â”‚  â”‚    â€¢ event: "session_complete"                     â”‚             â”‚
â”‚  â”‚    â€¢ persona: "student" | "parent" | "tutor"       â”‚             â”‚
â”‚  â”‚    â€¢ subject: "Algebra"                            â”‚             â”‚
â”‚  â”‚    â€¢ cooldowns: { buddy_challenge_hours: 25 }      â”‚             â”‚
â”‚  â”‚                                                     â”‚             â”‚
â”‚  â”‚  Logic:                                            â”‚             â”‚
â”‚  â”‚    â€¢ Check eligibility (persona + event)           â”‚             â”‚
â”‚  â”‚    â€¢ Validate cooldowns                            â”‚             â”‚
â”‚  â”‚    â€¢ Select best loop                              â”‚             â”‚
â”‚  â”‚                                                     â”‚             â”‚
â”‚  â”‚  Output:                                           â”‚             â”‚
â”‚  â”‚    â€¢ loop: "buddy_challenge"                       â”‚             â”‚
â”‚  â”‚    â€¢ eligibility_reason: "cooldown_ok"             â”‚             â”‚
â”‚  â”‚    â€¢ rationale: "Selected buddy_challenge..."      â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                       â”‚                                              â”‚
â”‚                       â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚         Personalization Agent                      â”‚             â”‚
â”‚  â”‚  POST /api/personalize/compose                     â”‚             â”‚
â”‚  â”‚                                                     â”‚             â”‚
â”‚  â”‚  Input:                                            â”‚             â”‚
â”‚  â”‚    â€¢ intent: "challenge_friend"                    â”‚             â”‚
â”‚  â”‚    â€¢ persona: "student"                            â”‚             â”‚
â”‚  â”‚    â€¢ subject: "Algebra"                            â”‚             â”‚
â”‚  â”‚    â€¢ loop: "buddy_challenge"                       â”‚             â”‚
â”‚  â”‚                                                     â”‚             â”‚
â”‚  â”‚  Logic:                                            â”‚             â”‚
â”‚  â”‚    â€¢ Lookup persona Ã— loop template                â”‚             â”‚
â”‚  â”‚    â€¢ Generate personalized copy                    â”‚             â”‚
â”‚  â”‚    â€¢ Attach reward preview                         â”‚             â”‚
â”‚  â”‚                                                     â”‚             â”‚
â”‚  â”‚  Output:                                           â”‚             â”‚
â”‚  â”‚    â€¢ copy: "I just completed Algebra! ğŸ¯"          â”‚             â”‚
â”‚  â”‚    â€¢ reward_preview: { type: "streak_shield" }     â”‚             â”‚
â”‚  â”‚    â€¢ deep_link_params: { subject, loop }           â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                       â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          VIRAL LOOP LAYER                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  User Clicks CTA in Agent Buddy Speech Bubble                        â”‚
â”‚         â”‚                                                             â”‚
â”‚         â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚  Open Modal (Challenge / Share / Spotlight)   â”‚                   â”‚
â”‚  â”‚                                               â”‚                   â”‚
â”‚  â”‚  â€¢ Preview content                            â”‚                   â”‚
â”‚  â”‚  â€¢ Invite friends section                     â”‚                   â”‚
â”‚  â”‚  â€¢ Share options (WhatsApp, Copy, Email)      â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                     â”‚                                                 â”‚
â”‚                     â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚       Create Smart Link                            â”‚             â”‚
â”‚  â”‚  POST /api/smart-links/create                      â”‚             â”‚
â”‚  â”‚                                                     â”‚             â”‚
â”‚  â”‚  Input:                                            â”‚             â”‚
â”‚  â”‚    â€¢ inviterId: userId                             â”‚             â”‚
â”‚  â”‚    â€¢ loop: "buddy_challenge"                       â”‚             â”‚
â”‚  â”‚    â€¢ params: { subject, resultId, ... }            â”‚             â”‚
â”‚  â”‚                                                     â”‚             â”‚
â”‚  â”‚  Process:                                          â”‚             â”‚
â”‚  â”‚    â€¢ Generate unique 12-char code                  â”‚             â”‚
â”‚  â”‚    â€¢ Sign with HMAC (tamper-proof)                 â”‚             â”‚
â”‚  â”‚    â€¢ Set 7-day expiry                              â”‚             â”‚
â”‚  â”‚    â€¢ Rate limit check (10/day for students)        â”‚             â”‚
â”‚  â”‚    â€¢ Insert into smart_links table                 â”‚             â”‚
â”‚  â”‚                                                     â”‚             â”‚
â”‚  â”‚  Output:                                           â”‚             â”‚
â”‚  â”‚    â€¢ code: "a1b2c3d4e5f6"                          â”‚             â”‚
â”‚  â”‚    â€¢ url: "https://app.com/sl/a1b2c3d4e5f6"        â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                       â”‚                                              â”‚
â”‚                       â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚  User Shares Link (WhatsApp, Copy, Email)    â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                     â”‚                                                 â”‚
â”‚                     â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  Track Event: "invite.sent"                        â”‚             â”‚
â”‚  â”‚    â€¢ loop: "buddy_challenge"                       â”‚             â”‚
â”‚  â”‚    â€¢ smartLinkCode: "a1b2c3d4e5f6"                 â”‚             â”‚
â”‚  â”‚    â€¢ channel: "whatsapp"                           â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                   Friend Clicks Link
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ATTRIBUTION LAYER                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  GET /sl/{code}  (Smart Link Resolver)             â”‚             â”‚
â”‚  â”‚                                                     â”‚             â”‚
â”‚  â”‚  Process:                                          â”‚             â”‚
â”‚  â”‚    â€¢ Validate HMAC signature                       â”‚             â”‚
â”‚  â”‚    â€¢ Check expiry (7 days)                         â”‚             â”‚
â”‚  â”‚    â€¢ Load smart link from DB                       â”‚             â”‚
â”‚  â”‚    â€¢ Set attribution cookie                        â”‚             â”‚
â”‚  â”‚    â€¢ Track "invite.opened" event                   â”‚             â”‚
â”‚  â”‚    â€¢ Redirect to FVM (First Value Moment)          â”‚             â”‚
â”‚  â”‚                                                     â”‚             â”‚
â”‚  â”‚  Redirect:                                         â”‚             â”‚
â”‚  â”‚    /fvm/skill/deck-1?inviter={id}&loop=buddy_...   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                       â”‚                                              â”‚
â”‚                       â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  FVM: Friend Takes Challenge                       â”‚             â”‚
â”‚  â”‚                                                     â”‚             â”‚
â”‚  â”‚  â€¢ Tracks "invite.fvm" event (reached FVM)         â”‚             â”‚
â”‚  â”‚  â€¢ Shows challenge preview                         â”‚             â”‚
â”‚  â”‚  â€¢ Encourages signup/login                         â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                       â”‚                                              â”‚
â”‚               Friend Completes Challenge                             â”‚
â”‚                       â”‚                                              â”‚
â”‚                       â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  Track Event: "invite.joined"                      â”‚             â”‚
â”‚  â”‚    â€¢ inviterId: original user                      â”‚             â”‚
â”‚  â”‚    â€¢ loop: "buddy_challenge"                       â”‚             â”‚
â”‚  â”‚    â€¢ score: 90                                     â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                       â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        REWARDS LAYER                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  Incentives Agent (Future MCP)                     â”‚             â”‚
â”‚  â”‚  POST /api/rewards/grant                           â”‚             â”‚
â”‚  â”‚                                                     â”‚             â”‚
â”‚  â”‚  Triggered by: "invite.joined" event               â”‚             â”‚
â”‚  â”‚                                                     â”‚             â”‚
â”‚  â”‚  Process:                                          â”‚             â”‚
â”‚  â”‚    â€¢ Validate eligibility (not duplicate)          â”‚             â”‚
â”‚  â”‚    â€¢ Check unit economics (cost limits)            â”‚             â”‚
â”‚  â”‚    â€¢ Calculate reward amount                       â”‚             â”‚
â”‚  â”‚    â€¢ Insert into rewards table                     â”‚             â”‚
â”‚  â”‚    â€¢ Update ledger_entries (cost tracking)         â”‚             â”‚
â”‚  â”‚                                                     â”‚             â”‚
â”‚  â”‚  Grant Reward:                                     â”‚             â”‚
â”‚  â”‚    â€¢ userId: inviterId (original user)             â”‚             â”‚
â”‚  â”‚    â€¢ type: "streak_shield"                         â”‚             â”‚
â”‚  â”‚    â€¢ amount: 1                                     â”‚             â”‚
â”‚  â”‚    â€¢ status: "granted"                             â”‚             â”‚
â”‚  â”‚    â€¢ dedupeKey: prevents duplicate rewards         â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                       â”‚                                              â”‚
â”‚                       â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  Notify Original User (Inviter)                    â”‚             â”‚
â”‚  â”‚                                                     â”‚             â”‚
â”‚  â”‚  â€¢ Real-time notification (SSE or polling)         â”‚             â”‚
â”‚  â”‚  â€¢ Agent buddy speech bubble updates:              â”‚             â”‚
â”‚  â”‚    "Awesome! Emma completed your challenge! ğŸ‰"    â”‚             â”‚
â”‚  â”‚  â€¢ Show celebration animation                      â”‚             â”‚
â”‚  â”‚  â€¢ Update XP bar / reward balance                  â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     SUPPORTING SYSTEMS                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  Presence System (SSE)              Leaderboards (Redis ZSET)        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ POST /api/presence/ â”‚            â”‚ GET /api/leaderboardâ”‚         â”‚
â”‚  â”‚      ping           â”‚            â”‚     /[subject]      â”‚         â”‚
â”‚  â”‚                     â”‚            â”‚                     â”‚         â”‚
â”‚  â”‚ â€¢ Heartbeat every   â”‚            â”‚ â€¢ Top N users by    â”‚         â”‚
â”‚  â”‚   30 seconds        â”‚            â”‚   subject           â”‚         â”‚
â”‚  â”‚ â€¢ Store in Redis    â”‚            â”‚ â€¢ Cached in Redis   â”‚         â”‚
â”‚  â”‚ â€¢ TTL: 60s          â”‚            â”‚ â€¢ Updates real-time â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                       â”‚
â”‚  Cohorts System                     Results/Progress                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ POST /api/cohorts   â”‚            â”‚ POST /api/results   â”‚         â”‚
â”‚  â”‚                     â”‚            â”‚                     â”‚         â”‚
â”‚  â”‚ â€¢ Create study      â”‚            â”‚ â€¢ Store session     â”‚         â”‚
â”‚  â”‚   groups            â”‚            â”‚   results           â”‚         â”‚
â”‚  â”‚ â€¢ Invite members    â”‚            â”‚ â€¢ Calculate stats   â”‚         â”‚
â”‚  â”‚ â€¢ Track activity    â”‚            â”‚ â€¢ Trigger agents    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow: End-to-End Example

### Scenario: Student completes Algebra session â†’ Invites friend â†’ Friend joins â†’ Both get rewards

```
Step 1: Student completes session
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Student UI                   â†’  POST /api/events
                                {
                                  name: "session.complete",
                                  payload: { subject: "Algebra", score: 85 }
                                }

Step 2: Agent decides viral loop
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Agent Buddy Component        â†’  POST /api/orchestrator/choose_loop
                                {
                                  event: "session_complete",
                                  persona: "student",
                                  subject: "Algebra",
                                  cooldowns: {}
                                }
                             â†  {
                                  loop: "buddy_challenge",
                                  rationale: "Selected buddy_challenge..."
                                }

Step 3: Personalize CTA copy
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Agent Buddy Component        â†’  POST /api/personalize/compose
                                {
                                  intent: "challenge_friend",
                                  persona: "student",
                                  subject: "Algebra",
                                  loop: "buddy_challenge"
                                }
                             â†  {
                                  copy: "I just crushed Algebra! Challenge me? ğŸ¯",
                                  reward_preview: {
                                    type: "streak_shield",
                                    amount: 1,
                                    description: "Get a shield when friend completes"
                                  }
                                }

Step 4: Show speech bubble
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Agent Buddy renders:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¤–                                       â”‚
â”‚   I just crushed Algebra!                â”‚
â”‚   Challenge me? ğŸ¯                       â”‚
â”‚                                          â”‚
â”‚   [Create Challenge] ğŸ›¡ï¸ +1 if friend    â”‚
â”‚   completes                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 5: Student clicks CTA
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ChallengeModal opens with:
- Challenge preview (subject, questions, difficulty)
- Share options (WhatsApp, Copy Link, Email)
- Reward preview visual

Step 6: Generate smart link
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Modal Component              â†’  POST /api/smart-links/create
                                {
                                  inviterId: "student-123",
                                  loop: "buddy_challenge",
                                  params: {
                                    subject: "Algebra",
                                    resultId: "result-456"
                                  }
                                }
                             â†  {
                                  code: "a1b2c3d4e5f6",
                                  url: "https://app.com/sl/a1b2c3d4e5f6"
                                }

Step 7: Track invite sent
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Modal Component              â†’  POST /api/events
                                {
                                  name: "invite.sent",
                                  payload: {
                                    loop: "buddy_challenge",
                                    smartLinkCode: "a1b2c3d4e5f6",
                                    channel: "whatsapp"
                                  }
                                }

Step 8: Student shares to WhatsApp
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
WhatsApp message:
"I just crushed Algebra! Challenge me? ğŸ¯
https://app.com/sl/a1b2c3d4e5f6"

Step 9: Friend clicks link
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Friend's Browser             â†’  GET /sl/a1b2c3d4e5f6
Smart Link Resolver:
  1. Validates HMAC signature âœ“
  2. Checks expiry âœ“
  3. Sets attribution cookie (inviter=student-123, loop=buddy_challenge)
  4. Tracks "invite.opened" event
  5. Redirects to FVM:
                             â†’  /fvm/skill/deck-1?inviter=student-123&loop=buddy_challenge

Step 10: Friend reaches FVM
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FVM Component (useEffect)    â†’  POST /api/events
                                {
                                  name: "invite.fvm",
                                  payload: {
                                    inviterId: "student-123",
                                    loop: "buddy_challenge"
                                  }
                                }

FVM shows:
- Challenge preview
- "Sign up to compete with your friend!"
- Quick signup form

Step 11: Friend completes challenge
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FVM Component                â†’  POST /api/results
                                {
                                  userId: "friend-789",
                                  subject: "Algebra",
                                  score: 90,
                                  metadata: {
                                    challengeId: "challenge-456",
                                    inviterId: "student-123"
                                  }
                                }

FVM Component                â†’  POST /api/events
                                {
                                  name: "invite.joined",
                                  payload: {
                                    inviterId: "student-123",
                                    loop: "buddy_challenge",
                                    score: 90,
                                    friendId: "friend-789"
                                  }
                                }

Step 12: Grant rewards
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Backend (triggered by        â†’  POST /api/rewards/grant
"invite.joined" event)          {
                                  userId: "student-123", // inviter
                                  type: "streak_shield",
                                  amount: 1,
                                  loop: "buddy_challenge",
                                  dedupeKey: "student-123-challenge-456"
                                }

Backend also grants to friend:
                             â†’  POST /api/rewards/grant
                                {
                                  userId: "friend-789",
                                  type: "ai_minutes",
                                  amount: 5,
                                  loop: "buddy_challenge"
                                }

Step 13: Notify student (inviter)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Student's Dashboard          â†  SSE stream or polling detects new reward

Agent Buddy updates:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¤– ğŸ‰                                     â”‚
â”‚   Awesome! Emma completed your challenge!â”‚
â”‚   You earned a streak shield! ğŸ›¡ï¸         â”‚
â”‚                                          â”‚
â”‚   +50 XP                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Celebration animation plays
XP bar animates +50 XP

Step 14: Metrics updated
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Admin Dashboard shows:
- K-factor calculation updated
- Conversion funnel updated:
  invite.sent â†’ invite.opened â†’ invite.fvm â†’ invite.joined
- Reward ledger updated (cost tracking)
```

---

## Database Relationships

```
users
  â”œâ”€ id (PK)
  â”œâ”€ persona: student | parent | tutor
  â”œâ”€ guardianId (FK â†’ users.id for minors)
  â””â”€ onboardingCompleted

events
  â”œâ”€ id (PK)
  â”œâ”€ userId (FK â†’ users.id)
  â”œâ”€ loop: buddy_challenge | results_rally | proud_parent | tutor_spotlight
  â”œâ”€ name: session.complete | invite.sent | invite.joined | reward.granted
  â””â”€ props: JSONB (flexible metadata)

smart_links
  â”œâ”€ code (PK)
  â”œâ”€ inviterId (FK â†’ users.id)
  â”œâ”€ loop
  â”œâ”€ params: JSONB
  â”œâ”€ sig: HMAC signature
  â””â”€ expiresAt

rewards
  â”œâ”€ id (PK)
  â”œâ”€ userId (FK â†’ users.id)
  â”œâ”€ type: streak_shield | ai_minutes | badge | credits
  â”œâ”€ loop
  â”œâ”€ dedupeKey (unique constraint)
  â””â”€ status: pending | granted | denied

ledger_entries
  â”œâ”€ id (PK)
  â”œâ”€ rewardId (FK â†’ rewards.id)
  â”œâ”€ userId (FK â†’ users.id)
  â”œâ”€ totalCostCents (for unit economics tracking)
  â””â”€ metadata: JSONB

results
  â”œâ”€ id (PK)
  â”œâ”€ userId (FK â†’ users.id)
  â”œâ”€ subject
  â”œâ”€ score
  â””â”€ metadata: JSONB (can include challengeId, inviterId)

cohorts
  â”œâ”€ id (PK)
  â”œâ”€ name
  â”œâ”€ subject
  â””â”€ createdBy (FK â†’ users.id)
```

---

## Component Hierarchy (Visual)

```
RootLayout
â”‚
â”œâ”€ Sidebar (260px fixed)
â”‚  â”‚
â”‚  â”œâ”€ Logo / Brand Link
â”‚  â”‚
â”‚  â”œâ”€ SidebarNav
â”‚  â”‚  â”œâ”€ Dashboard
â”‚  â”‚  â”œâ”€ Cohorts
â”‚  â”‚  â”œâ”€ Results
â”‚  â”‚  â”œâ”€ Leaderboard
â”‚  â”‚  â”œâ”€ Rewards
â”‚  â”‚  â”œâ”€ Settings
â”‚  â”‚  â””â”€ Admin (if role === 'admin')
â”‚  â”‚
â”‚  â””â”€ InviteButton (bottom sticky)
â”‚
â””â”€ Main Area
   â”‚
   â”œâ”€ Header (14px height)
   â”‚  â”‚
   â”‚  â”œâ”€ CohortSwitcher (left)
   â”‚  â”‚
   â”‚  â””â”€ Right Section
   â”‚     â”œâ”€ CommandPalette Trigger (âŒ˜K)
   â”‚     â”œâ”€ PresencePill (28 online)
   â”‚     â””â”€ EnhancedUserProfileArea (NEW!)
   â”‚        â”‚
   â”‚        â”œâ”€ UserMenu (dropdown)
   â”‚        â”‚  â”œâ”€ Profile
   â”‚        â”‚  â”œâ”€ Settings
   â”‚        â”‚  â”œâ”€ Rewards Balance
   â”‚        â”‚  â””â”€ Logout
   â”‚        â”‚
   â”‚        â””â”€ AgentBuddy (NEW!)
   â”‚           â”‚
   â”‚           â”œâ”€ Animated GIF (companion image)
   â”‚           â”‚
   â”‚           â””â”€ SpeechBubble (queue system)
   â”‚              â”œâ”€ Personalized Copy
   â”‚              â”œâ”€ Interactive Links
   â”‚              â”œâ”€ Reward Preview
   â”‚              â””â”€ Celebration Emoji
   â”‚
   â””â”€ Content Area (scrollable)
      â”‚
      â”œâ”€ if persona === 'student'
      â”‚  â”‚
      â”‚  â””â”€ StudentDashboard
      â”‚     â”‚
      â”‚     â”œâ”€ Progress Section
      â”‚     â”‚  â”œâ”€ RadialProgressWidget (Algebra)
      â”‚     â”‚  â”œâ”€ RadialProgressWidget (Geometry)
      â”‚     â”‚  â””â”€ RadialProgressWidget (Calculus)
      â”‚     â”‚
      â”‚     â”œâ”€ Agentic CTAs Section
      â”‚     â”‚  â”œâ”€ AgenticCTACard (from orchestrator)
      â”‚     â”‚  â””â”€ QuickChallengeList
      â”‚     â”‚
      â”‚     â””â”€ Quick Actions Section
      â”‚        â”œâ”€ StreakCard (ğŸ”¥ 5 days)
      â”‚        â”œâ”€ StudyBuddyWidget (friends online)
      â”‚        â””â”€ RecentActivity
      â”‚
      â”œâ”€ if persona === 'parent'
      â”‚  â”‚
      â”‚  â””â”€ ParentDashboard
      â”‚     â”‚
      â”‚     â”œâ”€ ChildSelector (if multiple children)
      â”‚     â”‚
      â”‚     â”œâ”€ Progress Overview
      â”‚     â”‚  â”œâ”€ Weekly Summary Card
      â”‚     â”‚  â”œâ”€ Sessions Completed This Week
      â”‚     â”‚  â””â”€ Subjects Improved
      â”‚     â”‚
      â”‚     â”œâ”€ Session History Timeline
      â”‚     â”‚
      â”‚     â””â”€ Proud Parent Section
      â”‚        â”œâ”€ ProudParentMomentsCarousel
      â”‚        â””â”€ SafeShareControls
      â”‚
      â””â”€ if persona === 'tutor'
         â”‚
         â””â”€ TutorDashboard
            â”‚
            â”œâ”€ Today's Schedule
            â”‚  â””â”€ UpcomingSessionsCard
            â”‚
            â”œâ”€ Student Management
            â”‚  â””â”€ StudentRosterTable
            â”‚
            â””â”€ Viral Tools
               â”œâ”€ ReferralMetricsCard
               â”œâ”€ SpotlightCardCreator
               â””â”€ PrepPackGenerator


Modal System (Overlay)
â”‚
â”œâ”€ TallModal (base component)
â”‚  â”‚
â”‚  â”œâ”€ ChallengeModal
â”‚  â”‚  â”œâ”€ Challenge Preview
â”‚  â”‚  â”œâ”€ Invite Friends Section
â”‚  â”‚  â”œâ”€ Share Options (WhatsApp, Copy, Email)
â”‚  â”‚  â””â”€ Reward Preview
â”‚  â”‚
â”‚  â”œâ”€ ProudParentModal
â”‚  â”‚  â”œâ”€ Privacy-Safe Highlights
â”‚  â”‚  â”œâ”€ Customizable Message
â”‚  â”‚  â”œâ”€ Privacy Toggle Controls
â”‚  â”‚  â””â”€ Share Options
â”‚  â”‚
â”‚  â”œâ”€ TutorSpotlightModal
â”‚  â”‚  â”œâ”€ Spotlight Card Preview
â”‚  â”‚  â”œâ”€ Anonymized Student Success Stories
â”‚  â”‚  â”œâ”€ Professional Share Message
â”‚  â”‚  â””â”€ Referral Link + Tracking
â”‚  â”‚
â”‚  â””â”€ ShareModal (generic)
â”‚     â”œâ”€ OG Image Preview
â”‚     â”œâ”€ Smart Link Display
â”‚     â”œâ”€ Copy to Clipboard
â”‚     â””â”€ Direct Share Buttons
```

---

## API Routes Map

```
/api
â”‚
â”œâ”€ /auth/[...nextauth]                 Auth (next-auth)
â”‚
â”œâ”€ /events                              Event tracking
â”‚  â””â”€ POST: track any event â†’ DB
â”‚
â”œâ”€ /orchestrator
â”‚  â””â”€ /choose_loop                      Loop Orchestrator Agent
â”‚     â””â”€ POST: decide which viral loop to trigger
â”‚
â”œâ”€ /personalize
â”‚  â””â”€ /compose                          Personalization Agent
â”‚     â””â”€ POST: generate personalized copy
â”‚
â”œâ”€ /smart-links                         (future, currently in lib/)
â”‚  â””â”€ /create                           Smart link generation
â”‚     â””â”€ POST: create signed smart link
â”‚
â”œâ”€ /sl/[code]                           Smart link resolver
â”‚  â””â”€ GET: validate & redirect to FVM
â”‚
â”œâ”€ /rewards
â”‚  â”œâ”€ /grant                            Grant reward
â”‚  â”‚  â””â”€ POST: award user (with deduplication)
â”‚  â”œâ”€ /balances                         Get user balances
â”‚  â”‚  â””â”€ GET: fetch current balances by type
â”‚  â””â”€ /ledger                           View ledger
â”‚     â””â”€ GET: fetch transaction history
â”‚
â”œâ”€ /presence
â”‚  â”œâ”€ /ping                             Heartbeat
â”‚  â”‚  â””â”€ POST: update presence in Redis
â”‚  â””â”€ /stream                           SSE stream
â”‚     â””â”€ GET: subscribe to presence updates
â”‚
â”œâ”€ /leaderboard/[subject]               Leaderboards
â”‚  â””â”€ GET: fetch top N users
â”‚
â”œâ”€ /cohorts                             Cohort management
â”‚  â”œâ”€ GET: list cohorts
â”‚  â””â”€ POST: create cohort
â”‚
â”œâ”€ /results                             Results storage
â”‚  â”œâ”€ GET: fetch user results
â”‚  â””â”€ POST: save result
â”‚
â”œâ”€ /og                                  Share card generation
â”‚  â””â”€ GET: generate Open Graph image
â”‚
â”œâ”€ /user
â”‚  â”œâ”€ /me                               Current user
â”‚  â”‚  â””â”€ GET: fetch session user
â”‚  â”œâ”€ /persona                          Update persona
â”‚  â”‚  â””â”€ POST: change student/parent/tutor
â”‚  â””â”€ /onboarding-complete              Complete onboarding
â”‚     â””â”€ POST: mark onboarding done
â”‚
â”œâ”€ /attribution
â”‚  â””â”€ /track-joined                     Track attribution
â”‚     â””â”€ POST: record invite conversion
â”‚
â””â”€ /cron
   â””â”€ /refresh-rollups                  Background jobs
      â””â”€ GET: refresh metrics (called by Vercel Cron)
```

---

## State Management

### Client-Side State (React)

```typescript
// Global State (Context API or Zustand)
interface AppState {
  user: User | null;
  persona: "student" | "parent" | "tutor";
  currentCohort: Cohort | null;
  recentRewards: Reward[];
  agentBuddyState: {
    speechBubbles: SpeechBubble[];
    currentBubble: SpeechBubble | null;
  };
}

// Component-Level State
- Dashboard: loading, data, error
- AgentBuddy: bubbleQueue, isThinking, lastUpdate
- Modals: open/closed, modalData, isSubmitting
- Presence: onlineCount, onlineUsers, subject
```

### Server-Side State (Database)

```typescript
// PostgreSQL (via Drizzle ORM)
- users: personas, onboarding status
- events: all user actions
- rewards: pending/granted rewards
- smart_links: active invites
- results: session outcomes
- cohorts: study groups

// Redis (via Upstash)
- presence: SET (userId â†’ timestamp)
- leaderboards: ZSET (subject â†’ userId:score)
- rate_limits: STRING (userId:action â†’ count)
- cooldowns: STRING (userId:loop â†’ lastTriggered)
```

---

## Security & Privacy

### Smart Link Security

```
Generation:
1. Generate random 12-char code (URL-safe base64)
2. Create canonical query string (sorted params)
3. Sign with HMAC-SHA256 (secret key)
4. Store in DB with signature
5. Set 7-day expiry

Validation:
1. Fetch smart link by code
2. Reconstruct canonical query string
3. Re-compute HMAC with same secret
4. Compare signatures (timing-safe)
5. Check expiry
6. Reject if invalid or expired
```

### Share Card Privacy

```
Student Share Cards:
âœ… First name only (or anonymous)
âœ… Subject name
âœ… Score range (80-90%) not exact
âœ… No school name
âœ… No timestamps
âœ… No photos without consent

Parent Share Cards:
âœ… "My child" or first name only
âœ… No last names
âœ… No identifying locations
âœ… Aggregated progress (week, not daily)
âœ… Privacy toggle controls

Tutor Share Cards:
âœ… Anonymized student data
âœ… Aggregated success metrics
âœ… No student names
âœ… Professional branding only
```

### COPPA Compliance

```typescript
if (user.minor && !user.guardianId) {
  // Block external sharing
  throw new Error("Guardian approval required");
}

if (user.minor && isExternalShare) {
  const consent = await requestGuardianConsent({
    childId: user.id,
    guardianId: user.guardianId,
    shareType: action,
  });
  
  if (!consent.approved) {
    throw new Error("Guardian consent denied");
  }
}
```

---

## Performance Considerations

### Orchestrator Latency Budget

```
Target: <150ms (UI-critical)
Timeout: 150ms â†’ fallback to default loop
Cache: 30s TTL per user Ã— event combination

Optimization:
- Run synchronously (no LLM calls)
- Simple if/else logic
- Precomputed cooldowns
- Minimal DB queries
```

### Personalization Latency Budget

```
Target: <200ms
Cache: 60s TTL per persona Ã— loop Ã— subject
Fallback: Generic copy if timeout

Optimization:
- Template-based (no LLM)
- In-memory lookups
- Precomputed reward previews
```

### Dashboard Load Time

```
Target: <2s on average connection

Optimization:
- Server-side render (Next.js RSC)
- Parallel data fetching
- Incremental Static Regeneration (ISR)
- Skeleton loaders for slow queries
- Code splitting per persona dashboard
```

---

## Testing Strategy

### Unit Tests

```typescript
// Agent logic
test("orchestrator selects buddy_challenge for student after session", () => {
  const output = chooseLoop({
    event: "session_complete",
    persona: "student",
    cooldowns: {},
  });
  expect(output.loop).toBe("buddy_challenge");
});

// Smart link generation
test("smart link signature is valid", async () => {
  const { code, url } = await createSmartLink({
    inviterId: "user-123",
    loop: "buddy_challenge",
  });
  const isValid = await validateSmartLinkSignature(code);
  expect(isValid).toBe(true);
});
```

### Integration Tests

```typescript
// End-to-end viral loop
test("user creates challenge â†’ friend joins â†’ rewards granted", async () => {
  // 1. Create smart link
  const { url } = await createSmartLink({...});
  
  // 2. Friend clicks link
  const response = await fetch(url);
  expect(response.redirected).toBe(true);
  
  // 3. Friend completes challenge
  await completeChallenge({...});
  
  // 4. Check rewards granted
  const rewards = await fetchRewards("user-123");
  expect(rewards).toContainEqual({
    type: "streak_shield",
    amount: 1,
  });
});
```

### E2E Tests (Playwright)

```typescript
test("student dashboard shows agent buddy with speech bubble", async ({ page }) => {
  await page.goto("/app");
  await expect(page.locator("[data-testid='agent-buddy']")).toBeVisible();
  await expect(page.locator("[data-testid='speech-bubble']")).toContainText(/Challenge/);
});
```

---

**Last Updated:** November 7, 2025  
**Maintained by:** Full Stack Team

